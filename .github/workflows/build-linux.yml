name: Build MomSurfFix Extension on Linux

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install build dependencies (GCC 9 + 32bit)
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update

        # 【关键修改1】直接安装 gcc-9-multilib 和 g++-9-multilib
        # 这会自动处理好所有的 32 位依赖，比手动装 libc6-dev-i386 更稳
        sudo apt-get install -y --no-install-recommends \
          gcc-9-multilib g++-9-multilib \
          make python3 python3-pip git ca-certificates

        # 【关键修改2】强制将系统默认编译器指向 GCC 9
        # 这样确保 AMBuild 绝对不会意外调用到 GCC 11
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-9 100
        sudo update-alternatives --install /usr/bin/cc cc /usr/bin/gcc-9 100
        sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/g++-9 100

        # 验证版本 (应该是 9.x)
        gcc --version
        g++ --version

    - name: Install AMBuild
      run: |
        python3 -m pip install --user --upgrade pip
        python3 -m pip install --user ambuild
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Checkout SourceMod SDKs
      run: |
        mkdir -p sdks
        cd sdks
        git clone --recursive https://github.com/alliedmodders/sourcemod -b 1.12-dev sourcemod
        git clone --recursive https://github.com/alliedmodders/metamod-source -b 1.12-dev mmsource
        git clone --recursive https://github.com/alliedmodders/hl2sdk -b csgo hl2sdk-csgo

    - name: Configure
      run: |
        mkdir build
        cd build
        # 不需要再手动指定 CC/CXX 了，因为系统默认已经改成了 GCC 9
        python3 ../configure.py \
          --enable-optimize \
          --sdks=csgo \
          --targets=x86 \
          --sm-path="${{ github.workspace }}/sdks/sourcemod" \
          --mms-path="${{ github.workspace }}/sdks/mmsource" \
          --hl2sdk-path="${{ github.workspace }}/sdks/hl2sdk-csgo"

    - name: Build
      run: |
        cd build
        ambuild

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: momsurffix_ext_linux
        path: build/package/addons/sourcemod/extensions/momsurffix_ext.ext.so
