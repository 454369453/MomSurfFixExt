name: Build CS:GO Extension

on:
  push:
    branches: ["master", "main", "gammacase"] # ç¡®ä¿åŒ…å«ä½ ç°åœ¨çš„åˆ†æ”¯
  pull_request:

jobs:
  build:
    name: Compile Extension
    # ğŸŒŸ å¼ºçƒˆå»ºè®®ç”¨ 20.04 é¿å… GCC ç‰ˆæœ¬è¿‡é«˜å¯¼è‡´çš„ SDK æŠ¥é”™
    runs-on: ubuntu-20.04
    
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: extension
          # ğŸŒŸ å¦‚æœä½ çš„ SDK æ˜¯ä½œä¸º git submodule æ·»åŠ çš„ï¼Œå¿…é¡»é€’å½’æ‹‰å–
          submodules: recursive 

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install AMBuild
        run: pip install git+https://github.com/alliedmodders/ambuild

      # ğŸŒŸã€å…³é”®æ­¥éª¤ã€‘å®‰è£… 32 ä½ç¼–è¯‘ç¯å¢ƒï¼Œå¦åˆ™ 100% å¤±è´¥
      - name: Install Linux 32-bit Dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            gcc-multilib g++-multilib \
            libstdc++6:i386 \
            libc6-dev-i386 \
            clang

      # ğŸŒŸã€ä¿é™©æ­¥éª¤ã€‘æ‰‹åŠ¨æ‹‰å– SDK (é˜²æ­¢ä½ çš„ submodule é…ç½®æœ‰è¯¯)
      # å¦‚æœä½ ç¡®å®šä½ çš„ä»“åº“é‡Œ submodule æ²¡é—®é¢˜ï¼Œè¿™æ­¥å¯ä»¥åˆ æ‰
      - name: Manual Checkout SDKs
        run: |
          mkdir sdks
          cd sdks
          git clone https://github.com/alliedmodders/sourcemod --recursive --branch master sourcemod
          git clone https://github.com/alliedmodders/mmsource --recursive --branch master mmsource
          git clone https://github.com/alliedmodders/hl2sdk-csgo --recursive --branch master hl2sdk-csgo

      - name: Compile
        run: |
          mkdir build
          cd build
          # ğŸŒŸ è¿™é‡Œå‡è®¾ä½ ç”¨çš„æ˜¯ AMBuild (configure.py)
          # æˆ‘ä»¬æ˜¾å¼æŒ‡å®š SDK è·¯å¾„ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
          python3 ../extension/configure.py \
            --enable-optimize \
            --sdks=csgo \
            --targets=x86 \
            --sm-path=${{ github.workspace }}/sdks/sourcemod \
            --mms-path=${{ github.workspace }}/sdks/mmsource \
            --hl2sdk-root=${{ github.workspace }}/sdks
          
          ambuild

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: csgo-extension-linux
          path: build/package/*.so
